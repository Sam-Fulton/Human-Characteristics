<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background-color: #f4f4f4;
    }

    .rank-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      width: 80%;
      position: absolute;
      justify-content: center;
    }

    .rank-svg {
      width: 100%;
      max-width: 1200px; 
      position: relative;
      align-items: center;
      justify-content: center;
      display: flex;
    }

    .rank-label {
      position: relative;
      top: 50%;
      white-space: nowrap;
      font-size: 40px;
    }

    .rank-image {
      max-width: 100px;
      height: auto;
      cursor: move;
    }

    .reload-button {
        position: absolute;
        bottom: 30%;
    }

  </style>
</head>
<body>

<div class="rank-container">
    <text class="rank-label" id="label1" x="0%" y="50%">Poor</text>
  <div class="rank-svg" ondrop="drop(event)" ondragover="allowDrop(event)" x=50%>
  </div>
  <text class="rank-label" id="label2" x="90%" y="50%" text-anchor="end">Rich</text>
</div>

<button class="reload-button" onclick="reloadImagesAndUpload()">Next</button>

<script>
 function dragStart(event) {
  event.dataTransfer.setData('text/plain', event.target.dataset.index);
}

function allowDrop(event) {
  event.preventDefault();
}

function drop(event) {
  event.preventDefault();
  const draggedIndex = event.dataTransfer.getData('text/plain');
  const droppedIndex = event.target.dataset.index;

  if (draggedIndex !== droppedIndex) {
    const draggedImage = document.querySelector(`[data-index="${draggedIndex}"]`);
    const droppedImage = document.querySelector(`[data-index="${droppedIndex}"]`);

    if (draggedImage && droppedImage) {
      const parent = draggedImage.parentNode;

      const temp = document.createElement('div');
      parent.insertBefore(temp, draggedImage);
      parent.insertBefore(draggedImage, droppedImage);
      parent.insertBefore(droppedImage, temp);
      parent.removeChild(temp);

      draggedImage.dataset.index = droppedIndex;
      droppedImage.dataset.index = draggedIndex;
    }
  }
}

function addDragDropListeners(element) {
  element.draggable = true;
  element.ondragstart = dragStart;
}

function loadRandomImages(numImages) {
  const embedContainer = document.querySelector('.rank-svg');

  const owner = 'Sam-Fulton';
  const repo = 'Human-Characteristics';
  const path = 'resources/images';

  const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

  fetch(apiUrl)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Failed to fetch directory contents. Status: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (Array.isArray(data)) {
        const imageFiles = data
          .filter(file => file.type === 'file' && file.name.match(/\.(png)$/i));

        if (imageFiles.length >= numImages) {
          const randomImageFiles = getRandomElements(imageFiles, numImages);

          randomImageFiles.forEach((file, index) => {
            const imageUrl = `https://raw.githubusercontent.com/${owner}/${repo}/main/${path}/${file.name}`;

            const embedElement = document.createElement('embed');
            embedElement.src = imageUrl;
            embedElement.width = '100px';

            const xPosition = 30 + index * 10;
            embedElement.setAttribute('x', `${xPosition}%`);

            embedElement.dataset.index = index;
            embedElement.draggable = true;
            embedElement.ondragstart = dragStart;

            embedContainer.appendChild(embedElement);

            addDragDropListeners(embedElement);
          });
        } else {
          console.error(`Not enough valid image files found in the repository. Required: ${numImages}, Found: ${imageFiles.length}`);
        }
      } else {
        console.error('Invalid data format received from the GitHub API.');
      }
    })
    .catch(error => console.error('Error fetching directory contents:', error));
}

function getRandomElements(array, numElements) {
  const shuffledArray = array.sort(() => Math.random() - 0.5);
  return shuffledArray.slice(0, numElements);
}

function reloadImagesAndUpload() {
  sendFileToGoogleDrive();
  
  const embedContainer = document.querySelector('.rank-svg');
  embedContainer.innerHTML = '';

  loadRandomImages(5);
}

function sendFileToGoogleDrive() {
  console.log('Sending file to Google Drive...');

  const label1 = document.getElementById('label1').textContent;
  const label2 = document.getElementById('label2').textContent;

  const embedElements = document.querySelectorAll('.rank-svg embed');

  const content = {
    label1: label1,
    label2: label2,
    images: [],
  };

  embedElements.forEach(embedElement => {
    const index = embedElement.dataset.index;
    const imageUrl = embedElement.src;
    const filename = imageUrl.substring(imageUrl.lastIndexOf('/') + 1);

    content.images.push({
      index: index,
      filename: filename,
    });
  });

  const fileMetadata = {
    name: 'user.json',
    mimeType: 'application/json',
  };

  const media = {
    mimeType: 'application/json',
    body: JSON.stringify(content),
  };

  const token = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;

  fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=media', {
    method: 'POST',
    headers: new Headers({
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json',
    }),
    body: JSON.stringify(content),
  })
    .then(response => response.json())
    .then(data => console.log('File uploaded successfully:', data))
    .catch(error => console.error('Error uploading file:', error));
}


/*
gapi.load('client:auth2', initClient);

function initClient() {
  gapi.load('auth2', function() {
  gapi.auth2.init({
    client_id: 'YOUR_CLIENT_ID',
  });
  })};

  function onSignIn(googleUser) {
  const profile = googleUser.getBasicProfile();
  const userId = profile.getId();
  const userName = profile.getName();
  const userEmail = profile.getEmail();

  console.log('User ID: ' + userId);
  console.log('User Name: ' + userName);
  console.log('User Email: ' + userEmail);
}*/

loadRandomImages(5);
</script>
<script src="https://apis.google.com/js/api.js"></script>


</body>
</html>
